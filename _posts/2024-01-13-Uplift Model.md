---
layout: post
title:  "Uplift Model"
date: 2024-01-13
author: seolbluewings
categories: Statistics
---

업리프트 모델링(Uplift Model)은 특정 마케팅의 무작위 대조실험(A/B테스트) 결과를 분석하여 마케팅을 어떠한 유형의 고객에게 보내야 효과가 있는지를 예측하는데 사용하는 모델이다.

일반적인 A/B테스트 실험은 실험군과 대조군의 반응 여부만 판단하지만, Uplift Model은 실험군과 대조군에서 "어떤 특징을 가지는 표본"이 반응/반응하지 않았는지도 확인한다. 반응자들의 표본이 가지는 특징을 파악한 후, 마케팅 효과가 있을법한 대상을 예측하여 이후 선별적인 마케팅을 진행하고자 할 때 활용된다. 이 결과는 마케팅 시행 시, 광고 대상에서 제외되어야할 사람(회사 입장에서는 손해인 고객, 광고 노출 자체가 무의미한 사람(충성 고객) 등을 걸러내기 위한 용도로 활용될 수 있다. 

Uplift Model은 마케팅 시행(개입) 유무 / 전환(CV) 기준으로 4개의 범주로 대상을 구분할 수 있다. CV는 서비스 운영/마케팅 전략에 따라 달라질 수 있는 개념이나 CV는 반드시 개별 고객 단위로 발생해야 하며, 개별 CV 여부를 데이터를 통해 파악할 수 있어야 한다.

| 마케팅 미수행 | 마케팅 수행 | 범주 |대응 방안|
|---|:---:|:---:|---|
| `반응 안함` | `반응 안함`| 무관심(휴면 고객) | 비용 발생하는 마케팅 자제 |
| `반응 안함` | `반응 함`| 설득 가능(persuable) | 가능한 한 마케팅 대상에 포함시킴 |
| `반응 함` | `반응 안함` | 청개구리 | 마케팅 대상에 포함하지 않음 |
| `반응 함` | `반응 함` | 잡은 물고기 | 굳이 마케팅 해야할 이유가 없는 고객군, 비용 발생 마케팅 자제 |

__무관심(휴면 고객)__ : 마케팅 여부와 관계없이 CV되지 않을 고객으로 이미 서비스 이용내역이 과거 1년간 없는 고객 등을 의미한다. 이러한 고객의 경우는 휴면 고객으로 분류하여 마케팅 대상에서 제외하는 편이 비용을 아낄 수 있다.

__설득 가능(Persuable)__ : 마케팅을 시행하면 CV가 가능한 부류로 Uplift Model을 통해 궁극적으로 선별해내고자 하는 고객군이다. 

__청개구리__ : 마케팅을 수행하지 않으면 CV가 발생하나, 반대로 마케팅을 수행하면 CV하지 않는 고객군이다. 광고성 메세지가 오히려 부정적인 효과를 나타나게 하는 고객군으로 이러한 유형의 고객군은 마케팅을 시행하면 오히려 서비스에서 이탈한다.

__잡은 물고기__ : 마케팅 여부에 관계없이 CV가 발생하는 고객군이다. 알아서 서비스를 잘 이용해주는 고객군으로 오히려 할인과 같은 마케팅 비용이 매출 감소로 이어질 수 있다. 다만 마케팅 반응률 관점에서는 좋은 지표를 얻을 수 있어 KPI 관점에서 마케팅 대상에 포함시킬 수는 있다. 다만 마케팅에 비용이 수반되는 경우는 포함하지 않는 것이 바람직하다.

Uplift Model을 실제 서비스에 적용하는 과정은 다음과 같다.

__1.__ : 실험하려는 개입(마케팅)을 설계하고 실험군/대조군에 각각 어떠한 행위를 실행할지 결정한다.   
__2.__ : 일부 고객을 대상으로 무작위 대조 실험을 실시한다.   
__3.__ : 무작위 대조 실험 결과를 학습 데이터와 테스트 데이터로 나눈다.   
__4.__ : 학습 데이터를 활용하여 Uplift-Model 예측기를 만든다.   
__5.__ : 테스트 데이터를 활용하여 Uplift-Model 점수 예측 결과를 그래프로 그리고 점수 추이를 확인한다.   
__6.__ : Uplift-Model 점수 그래프를 통해 개입할 고객의 범위를 결정한다.   
__7.__ : 전체 고객을 대상으로 Uplift-Model을 적용한 점수를 예측한다.   
__8.__ : 예측한 점수를 바탕으로 개입할 고객군을 설정한다.   
__9.__ : 선정한 고객 중 일부는 개입하지 않는 대조군으로 설정하고 그 외 나머지를 실험군으로 설정한다.   
__10.__ : 실험군에 속하는 고객에게 개입을 실행한다.   
__11.__ : 실험군과 대조군의 CV를 비교해 개입의 효과를 측정한다.   
   


12개월 내 구매이력이 존재하는 고객을 대상으로 '남성을 타겟으로 하는 판촉 메일', '여성을 타겟으로 하는 판촉 메일', '메일 발송하지 않음'의 마케팅(개입) 행위를 수행하고 이에 대한 사이트 재방문을 CV로 간주한 데이터를 살펴볼 것이다.




Bayes Filter는 Kalman Filter, Particle Filter의 기본이 되는 개념으로 Bayes Rule을 따르는 재귀적인 필터이다. Bayes Filter는 prior와 likelihood를 통해서 posterior를 구하고 이 posterior가 다음 단계의 prior로 작용한다는 점에서 재귀적이라 표현한다.

Bayes Filter에 사용되는 notation을 활용하여 표현하면 다음과 같다.

초기시간 1부터 시간 t까지 측정센서 값의 시퀀스를 $$ \mathbf{z} =\{z_{1},z_{2},...,z_{t}\} $$, 제어입력의 시퀀스를 $$ \mathbf{u} =\{u_{1},u_{2},...,u_{t}\} $$ 로 정의하고 이 값이 주어졌을 때, 이를 조건부로 갖는 상태(state) 변수 $$ \mathbf{x} =\{x_{1},x_{2},...,x_{t}\} $$ 의 conditional pdf를 구하는 것이라 할 수 있다.

$$ \text{bel}(x_{t}) = p(x_{t}\vert z_{1:t},u_{1:t}) $$

이는 1부터 t시점까지의 센서값(z), 제어입력값(u)을 이용해서 t시점의 상태값 $$x_{t}$$를 확률적으로 추정하는 작업으로 $$ \text{bel}(x_{t}) $$ 값은 시간 t에서의 belief state 값이라고 부른다.

![label](https://github.com/seolbluewings/seolbluewings.github.io/blob/master/assets/bayes_filter.png?raw=true){:width="90%" height="80%"}{: .aligncenter}

Bayes Filter의 알고리즘은 다음의 프로세스를 따른다.


> $$\text{for all} \quad x_{t} \quad$$ do :   
>> $$\overline{\text{bel}}(x_{t}) = \int p(x_{t}\vert u_{t},x_{t-1})\text{bel}(x_{t-1})dx $$   
>> $$ \text{bel}(x_{t}) = \eta p(z_{t}\vert x_{t})\overline{\text{bel}}(x_{t}) $$   

> $$\text{end for} $$   
> $$ \text{return} \quad \text{bel}(x_{t}) $$   


이 Bayes Filter 프로세스는 다음과 같이 해석할 수 있다.

우선 첫번째 줄은 제어 업데이트(control update) 또는 예측(prediction)이라 불리는 단계로 제어값을 활용하여 상태값을 업데이트하는 작업이다. $$\text{bel}(x_{t-1})$$은 t-1시점의 상태값을 의미하며 $$p(x_{t}\vert u_{t},x_{t-1})$$ 값은 t-1시점의 상태값과 t시점의 제어값이 주어진 상황에서의 현재 t시점의 상태값의 확률 분포로 이 2가지 값을 활용하여 현재의 상태값을 예측하는 행위라 볼 수 있다.

두번째 줄은 측정 업데이트(measurement update) 또는 보정(correction)으로 불리며 이 작업은 센서값을 통해 측정한 값을 활용하여 prediction한 값을 보정한다.

이 2가지 제어/측정 업데이트 프로세스는 다음의 이유로 만족된다. 먼저 제어 업데이트 단계의 로직은 이러하다.

$$\overline{\text{bel}}(x_{t})$$값은 현재 t시점에 센서값 $$z_{t}$$ 없이 현재 상태를 추정한 것으로 $$\overline{\text{bel}}(x_{t}) = p(x_{t} \vert z_{1:t-1},u_{1:t})$$ 식이 성립된다.

$$
\begin{align}
\overline{\text{bel}}(x_{t}) &= p(x_{t} \vert z_{1:t-1},u_{1:t}) \\ \newline
&= \int p(x_{t}\vert x_{t-1},z_{1:t-1},u_{1:t})p(x_{t-1}\vert z_{1:t-1},u_{1:t})dx_{t-1}
\end{align}
$$

이 때, 조건부 $$x_{t-1}$$는 $$z_{1:t-1},u_{1:t-1}$$ 값을 포함한다는 Markov Assumption과 모든 $$\mathbf{u}$$와 $$\mathbf{z}$$는 독립적이라는 가정으로 인해 $$p(x_{t}\vert x_{t-1},z_{1:t-1},u_{1:t}) = p(x_{t}\vert x_{t-1},u_{t})$$ 를 만족하고 $$p(x_{t-1}\vert z_{1:t-1},u_{1:t})$$의 경우는 t-1시점에 $$u_{t}$$값이 존재할 수 없으므로 $$p(x_{t-1}\vert z_{1:t-1},u_{1:t-1})$$과 동일하며 이것은 $$\overline{\text{bel}}(x_{t-1})$$이라 표현할 수 있다. 따라서 제어 업데이트의 수식이 구성되는 것이다. 

$$\text{bel}(x_{t}) = p(x_{t}\vert z_{1:t},u_{1:t})$$를 구하는 측정 업데이트 단계의 로직은 다음과 같다. 

$$
\begin{align}
p(x_{t}\vert z_{1:t},u_{1:t}) &= \frac{p(z_{t}\vert x_{t},z_{1:t-1},u_{1:t})p(x_{t}\vert z_{1:t-1},u_{1:t})}{p(z_{t}\vert z_{1:t-1},u_{1:t})} \\ \newline
&= \eta p(z_{t}\vert x_{t},z_{1:t-1},u_{1:t})p(x_{t}\vert z_{1:t-1},u_{1:t}) \\ \newline
&= \eta p(z_{t}\vert x_{t})p(x_{t}\vert z_{1:t-1},u_{1:t})
\end{align}
$$

$$p(x_{t}\vert z_{1:t-1},u_{1:t})$$ 값은 제어 업데이트 단계에서 구하는 $$\overline{\text{bel}}(x_{t})$$ 값과 동일하며 Markov Assumption으로 인해 $$x_{t}$$가 $$z_{1:t-1},u_{1:t}$$를 포함하고 있어 2번째 줄에서 3번째 줄로 넘어갈 수 있는 것이 가능하다. 이는 현재의 위치 $$x_{t}$$에서 어떠한 물체를 관측할 때, 그 관측값에 대한 이전까지의 관측값($$z_{1:t-1}$$)과 이전까지의 제어값($$u_{1:t}$$)은 의미가 없고 오직 $$x_{t}$$ 값만이 의미가 있다는 것을 말한다.

이렇게 계산된 $$\text{bel}(x_{t})$$ 값은 그 다음 $$t+1$$시점에서 이전시점의 상태값으로 역할을 하여 재귀적인 단계가 진행된다.
다만, 제어 업데이트 단계에서 진행하는 적분으로 인해 이슈가 발생한다.

만약 $$\mathbf{x}$$가 discrete한 변수라면 이 적분은 확률값을 모두 더하는 것으로 치환될 수 있지만 discrete하지 않고 continuous하다면 적분을 해야만하는데 적분이 복잡하거나 적분이 불가능한 경우가 발생할 수도 있다. 적분 불가능 케이스에 대응하는 방법은 2가지가 있다.

첫째, 적분이 가능한 정규분포만 사용하는 것으로 이 경우 Bayes Filter를 Kalman Filter라고 부른다.
둘째, 적분 대신 Monte Carlo Integration이라는 Sampling 기반으로 근사값을 추론하게 되는데 이를 Particle Filter라고 부른다.

베이즈 필터에 대한 간략한 python 코드 예시는 다음의 [링크](https://github.com/seolbluewings/python_study/blob/master/01.study/bayes_filter.py)에서 확인할 수 있다.


#### 참조 문헌
1. [베이즈 필터 (Bayes Filter)](https://gaussian37.github.io/autodrive-ose-bayes_filter/) <br>
2. [SLAM - 베이즈 필터 알고리즘 (Bayes Filter Algorithm)](https://blog.naver.com/PostView.nhn?blogId=junghs1040&logNo=222345147315)

